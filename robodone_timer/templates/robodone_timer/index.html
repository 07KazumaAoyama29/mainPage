{% extends 'todo/base.html' %}
{% load static %}
{% block content %}
<div class="container py-5">
    <h1 class="text-center mb-4">ğŸ¤– äº¤ä»£ã‚¿ã‚¤ãƒãƒ¼ ğŸ±</h1>

    <div class="card mb-4">
        <div class="card-body">
            <form onsubmit="return false;">
                <div class="row g-3 align-items-center justify-content-center">
                    
                    <div class="col-auto">
                        <label class="col-form-label fw-bold">å…¨ä½“æ™‚é–“</label>
                    </div>
                    <div class="col-auto">
                        <div class="input-group">
                            <input type="number" id="totalMin" class="form-control" value="60" min="0" style="width: 80px;">
                            <span class="input-group-text">åˆ†</span>
                            <input type="number" id="totalSec" class="form-control" value="0" min="0" max="59" style="width: 80px;">
                            <span class="input-group-text">ç§’</span>
                        </div>
                    </div>

                    <div class="w-100 d-md-none"></div>

                    <div class="col-auto ms-md-4">
                        <label class="col-form-label fw-bold">äº¤ä»£é–“éš”</label>
                    </div>
                    <div class="col-auto">
                        <div class="input-group">
                            <input type="number" id="turnMin" class="form-control" value="10" min="0" style="width: 80px;">
                            <span class="input-group-text">åˆ†</span>
                            <input type="number" id="turnSec" class="form-control" value="0" min="0" max="59" style="width: 80px;">
                            <span class="input-group-text">ç§’</span>
                        </div>
                    </div>

                    <div class="col-auto ms-md-4">
                        <button class="btn btn-primary px-4" onclick="startTimer()" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                        <button class="btn btn-secondary px-4" onclick="resetTimer()" id="resetBtn" disabled>ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card h-100 text-center" id="charCard" style="background-color: #f8f9fa; transition: background-color 0.5s;">
                <div class="card-body d-flex flex-column justify-content-center align-items-center" style="min-height: 300px;">
                    <div id="charIcon" style="font-size: 8rem;">ğŸ­</div>
                    <h2 class="display-4 fw-bold" id="charName">ã­ãšãƒœãƒƒãƒˆ</h2>
                    <p class="fs-4 text-muted" id="turnStatus">å¾…æ©Ÿä¸­...</p>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-body d-flex flex-column justify-content-center text-center">
                    
                    <h5 class="text-muted">å…¨ä½“æ®‹ã‚Šæ™‚é–“</h5>
                    <div class="display-1 fw-bold mb-4" id="totalCountdown">00:00</div>
                    
                    <hr>

                    <h5 class="text-muted">äº¤ä»£ã¾ã§ã‚ã¨</h5>
                    <div class="display-2 fw-bold text-danger" id="turnCountdown">00:00</div>

                    <div class="progress mt-3" style="height: 25px;">
                        <div id="turnProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let intervalId = null;
    let totalSecondsLeft = 0;
    let turnSecondsLeft = 0;
    let currentTurnIndex = 0; // 0:ã­ãšãƒœãƒƒãƒˆ, 1:ãƒ­ãƒœã«ã‚ƒã‚“
    let turnDurationSec = 0;

    const charConfig = [
        { name: "ã­ãšãƒœãƒƒãƒˆ", icon: "ğŸ­", color: "#e3f2fd", class: "bg-info" }, // è–„ã„é’
        { name: "ãƒ­ãƒœã«ã‚ƒã‚“", icon: "ğŸ±", color: "#fce4ec", class: "bg-danger" }  // è–„ã„èµ¤
    ];

    // åŠ¹æœéŸ³ï¼ˆå¿…è¦ãªã‚‰ï¼‰
    //const switchSound = new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg');
    const switchSound = new Audio("{% static 'robodone_timer/sounds/timer.mp3' %}");

    function startTimer() {
        // å€¤ã®å–å¾—ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        const totalMin = parseInt(document.getElementById('totalMin').value) || 0;
        const totalSec = parseInt(document.getElementById('totalSec').value) || 0;
        const turnMin = parseInt(document.getElementById('turnMin').value) || 0;
        const turnSec = parseInt(document.getElementById('turnSec').value) || 0;

        // ç§’æ›ç®—
        const totalDuration = (totalMin * 60) + totalSec;
        turnDurationSec = (turnMin * 60) + turnSec;

        if (totalDuration <= 0 || turnDurationSec <= 0) {
            return alert("æœ‰åŠ¹ãªæ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        }

        // åˆæœŸåŒ–
        totalSecondsLeft = totalDuration;
        turnSecondsLeft = turnDurationSec;
        currentTurnIndex = 0;

        // UIãƒ­ãƒƒã‚¯
        setInputsDisabled(true);
        
        updateDisplay();
        updateCharacter();

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        intervalId = setInterval(() => {
            totalSecondsLeft--;
            turnSecondsLeft--;

            // äº¤ä»£ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
            if (turnSecondsLeft <= 0 && totalSecondsLeft > 0) {
                currentTurnIndex = (currentTurnIndex + 1) % 2; 
                turnSecondsLeft = turnDurationSec; 
                switchSound.play().catch(e => {}); // ã‚¨ãƒ©ãƒ¼ç„¡è¦–
                updateCharacter();
            }

            // çµ‚äº†åˆ¤å®š
            if (totalSecondsLeft <= 0) {
                finishTimer();
            }

            updateDisplay();
        }, 1000);
    }

    function resetTimer() {
        clearInterval(intervalId);
        setInputsDisabled(false);
        
        document.getElementById('totalCountdown').innerText = "00:00";
        document.getElementById('turnCountdown').innerText = "00:00";
        document.getElementById('turnProgress').style.width = "0%";
        
        // åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
        document.getElementById('charIcon').innerText = "ğŸ­";
        document.getElementById('charName').innerText = "ã­ãšãƒœãƒƒãƒˆ";
        document.getElementById('charCard').style.backgroundColor = "#f8f9fa";
        document.getElementById('turnStatus').innerText = "å¾…æ©Ÿä¸­...";
    }

    function finishTimer() {
        clearInterval(intervalId);
        totalSecondsLeft = 0;
        turnSecondsLeft = 0;
        updateDisplay();
        alert("çµ‚äº†ã§ã™ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼");
        resetTimer();
    }

    function setInputsDisabled(disabled) {
        document.getElementById('startBtn').disabled = disabled;
        document.getElementById('resetBtn').disabled = !disabled;
        document.getElementById('totalMin').disabled = disabled;
        document.getElementById('totalSec').disabled = disabled;
        document.getElementById('turnMin').disabled = disabled;
        document.getElementById('turnSec').disabled = disabled;
    }

    function updateDisplay() {
        // å…¨ä½“æ™‚é–“
        const totalM = Math.floor(totalSecondsLeft / 60);
        const totalS = totalSecondsLeft % 60;
        document.getElementById('totalCountdown').innerText = 
            `${String(totalM).padStart(2, '0')}:${String(totalS).padStart(2, '0')}`;

        // äº¤ä»£æ™‚é–“
        const turnM = Math.floor(turnSecondsLeft / 60);
        const turnS = turnSecondsLeft % 60;
        document.getElementById('turnCountdown').innerText = 
            `${String(turnM).padStart(2, '0')}:${String(turnS).padStart(2, '0')}`;

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
        const percentage = ((turnDurationSec - turnSecondsLeft) / turnDurationSec) * 100;
        document.getElementById('turnProgress').style.width = `${percentage}%`;
    }

    function updateCharacter() {
        const char = charConfig[currentTurnIndex];
        
        document.getElementById('charIcon').innerText = char.icon;
        document.getElementById('charName').innerText = char.name;
        document.getElementById('charCard').style.backgroundColor = char.color;
        document.getElementById('turnStatus').innerText = "ã®ã‚¿ãƒ¼ãƒ³ï¼";
        
        const bar = document.getElementById('turnProgress');
        bar.className = `progress-bar progress-bar-striped progress-bar-animated ${currentTurnIndex === 0 ? 'bg-info' : 'bg-danger'}`;
    }
</script>
{% endblock %}