<form id="edit-task-form" hx-post="{% url 'todo:update' pk=schedule.pk %}">
  {% csrf_token %}
  <div class="modal-header">
    <h5 class="modal-title">スケジュールの編集</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    
    <div class="mb-3">
        <label for="{{ form.action_category.id_for_label }}" class="form-label">アクション区分</label>
        {{ form.action_category }}
        {% if form.action_category.errors %}
            <div class="text-danger small">{{ form.action_category.errors }}</div>
        {% endif %}
    </div>

    <div class="mb-3">
        <label for="{{ form.action_item.id_for_label }}" class="form-label">内容（本など）</label>
        {{ form.action_item }}
        <div class="form-text small">カテゴリに対応するリストから選択できます</div>
    </div>

    <div class="mb-3" id="edit-page-count-area" style="display: none;">
        <label for="{{ form.page_count.id_for_label }}" class="form-label">読んだページ数</label>
        <div class="input-group">
            {{ form.page_count }}
            <span class="input-group-text">ページ</span>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.start_time.id_for_label }}" class="form-label">開始</label>
            {{ form.start_time }}
        </div>
        <div class="col-md-6 mb-3">
            <label for="{{ form.end_time.id_for_label }}" class="form-label">終了</label>
            {{ form.end_time }}
        </div>
    </div>

  </div>
  <div class="modal-footer justify-content-between">
    {# 削除ボタン #}
    <button type="button" class="btn btn-danger" 
            hx-post="{% url 'todo:delete' pk=schedule.pk %}"
            hx-confirm="このスケジュールを本当に削除しますか？"
            hx-target="body">
      削除
    </button>
    <div>
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
      <button type="submit" id="submit-edit-form" class="btn btn-primary">保存</button>
    </div>
  </div>
</form>

<script>
    (function() {
        // ビューから渡されたデータ
        const trackPagesMap = {{ track_pages_map|safe }};
        const itemsByCategory = {{ items_by_category|safe }};
        
        // 編集フォーム内の要素を取得
        // ※ID重複を避けるため、フォーム要素起点で探すのが安全ですが、
        // 今回はforms.pyでID指定している前提でgetElementByIdを使います。
        // もし作成フォームと同時に開くことがなければこれで動きます。
        const categorySelect = document.getElementById('id_action_category');
        const itemSelect = document.getElementById('id_action_item');
        const pageCountArea = document.getElementById('edit-page-count-area');

        // ▼ 1. アイテムリストを更新する関数
        function updateItemOptions() {
            const selectedId = categorySelect.value;
            // ★重要: 編集時は「元々保存されていた値」が初期状態で入っているはずなので、それをキープしたい
            const currentItemId = itemSelect.value; 

            // 選択肢をクリア
            itemSelect.innerHTML = '<option value="">（指定なし）</option>';

            if (selectedId && itemsByCategory[selectedId]) {
                const items = itemsByCategory[selectedId];
                items.forEach(function(item) {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.title;
                    itemSelect.appendChild(option);
                });
            }
            
            // リスト再構築後に、元の値を再選択する
            if (currentItemId) {
                itemSelect.value = currentItemId;
            }
        }

        // ▼ 2. ページ数入力欄の表示/非表示
        function togglePageCount() {
            const selectedId = categorySelect.value;
            if (selectedId && trackPagesMap[selectedId]) {
                pageCountArea.style.display = 'block';
            } else {
                pageCountArea.style.display = 'none';
                // 編集時は、カテゴリを変えても誤操作防止のため値はクリアしないほうが親切かもしれません
                // pageCountInput.value = ''; 
            }
        }

        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                updateItemOptions();
                togglePageCount();
            });
            
            // ★初期実行
            // 編集画面では「既にDBに入っている値」を元に表示を復元する必要があります。
            // しかし、サーバー側(Django)のフォームレンダリングで既に正しい<option>が出ているはずなので、
            // updateItemOptions() を即実行すると、Djangoがセットしてくれた初期値を消してしまう恐れがあります。
            // なので、初期ロード時は「ページ数の表示判定」だけ行い、
            // アイテムリストの更新は「カテゴリを変更した時」だけに任せるのが安全です。
            
            togglePageCount();
        }
    })();
</script>