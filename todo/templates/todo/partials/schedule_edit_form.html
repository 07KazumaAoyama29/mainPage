{# templates/todo/partials/schedule_edit_form.html #}

<form id="edit-task-form" hx-post="{% url 'todo:update' pk=schedule.pk %}">
  {% csrf_token %}
  <div class="modal-header">
    <h5 class="modal-title">スケジュールの編集</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    
    <div class="mb-3">
        <label for="{{ form.action_category.id_for_label }}" class="form-label">アクション区分</label>
        {{ form.action_category }}
        {% if form.action_category.errors %}
            <div class="text-danger small">{{ form.action_category.errors }}</div>
        {% endif %}
    </div>

    <div class="mb-3">
        <label for="{{ form.action_item.id_for_label }}" class="form-label">内容（本など）</label>
        {{ form.action_item }}
        <div class="form-text small">カテゴリに対応するリストから選択できます</div>
    </div>

    <div class="mb-3" id="edit-page-count-area" style="display: none;">
        <label class="form-label">読書ページ記録</label>
        
        <div class="input-group mb-2">
            <span class="input-group-text">P.</span>
            {{ form.start_page }}
            <span class="input-group-text">〜</span>
            {{ form.end_page }}
        </div>

        <div class="input-group">
            <span class="input-group-text">合計</span>
            {{ form.page_count }}
            <span class="input-group-text">ページ</span>
        </div>
        <div class="form-text small">終了ページを入力すると自動計算されます</div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.start_time.id_for_label }}" class="form-label">開始</label>
            {{ form.start_time }}
        </div>
        <div class="col-md-6 mb-3">
            <label for="{{ form.end_time.id_for_label }}" class="form-label">終了</label>
            {{ form.end_time }}
        </div>
    </div>

  </div>
  <div class="modal-footer justify-content-between">
    {# 削除ボタン #}
    <button type="button" class="btn btn-danger" 
            hx-post="{% url 'todo:delete' pk=schedule.pk %}"
            hx-confirm="このスケジュールを本当に削除しますか？"
            hx-target="body">
      削除
    </button>
    <div>
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
      <button type="submit" id="submit-edit-form" class="btn btn-primary">保存</button>
    </div>
  </div>
</form>

<script>
    (function() {
        // ビューから渡されたデータ
        const trackPagesMap = {{ track_pages_map|safe }};
        const itemsByCategory = {{ items_by_category|safe }};
        
        // 編集フォーム内の要素を取得
        // ※ID重複を避けるため、フォーム要素起点で探すのが安全ですが、forms.pyでID指定している前提で書きます
        const categorySelect = document.getElementById('id_action_category');
        const itemSelect = document.getElementById('id_action_item');
        const pageCountArea = document.getElementById('edit-page-count-area');
        
        // ★計算用の要素も取得
        const startInput = document.getElementById('id_start_page');
        const endInput = document.getElementById('id_end_page');
        const countInput = document.getElementById('id_page_count');

        // ▼ 自動計算ロジック
        function calculatePages() {
            const start = parseInt(startInput.value) || 0;
            const end = parseInt(endInput.value) || 0;
            if (endInput.value !== '' && end >= start) {
                countInput.value = end - start;
            }
        }

        // 入力イベントに計算ロジックを紐付け
        if (startInput && endInput) {
            startInput.addEventListener('input', calculatePages);
            endInput.addEventListener('input', calculatePages);
        }

        // ▼ アイテムリスト更新
        function updateItemOptions() {
            const selectedId = categorySelect.value;
            // 編集時は「元々保存されていた値」をキープしたい
            const currentItemId = itemSelect.value; 

            itemSelect.innerHTML = '<option value="">（指定なし）</option>';

            if (selectedId && itemsByCategory[selectedId]) {
                const items = itemsByCategory[selectedId];
                items.forEach(function(item) {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.title;
                    itemSelect.appendChild(option);
                });
            }
            
            // リスト再構築後に、元の値を再選択
            if (currentItemId) {
                itemSelect.value = currentItemId;
            }
        }

        // ▼ 表示切替
        function togglePageCount() {
            const selectedId = categorySelect.value;
            if (selectedId && trackPagesMap[selectedId]) {
                pageCountArea.style.display = 'block';
            } else {
                pageCountArea.style.display = 'none';
            }
        }

        if (categorySelect) {
            // カテゴリ変更時はリスト更新も行う
            categorySelect.addEventListener('change', function() {
                updateItemOptions();
                togglePageCount();
            });
            
            // ★編集画面の初期ロード時
            // ここでは「表示切替」だけ行い、アイテムリストの再構築(updateItemOptions)は行わない
            // （Djangoが既に正しい選択状態のHTMLを作ってくれているため）
            togglePageCount();
        }
    })();
</script>