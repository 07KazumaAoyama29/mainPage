{# templates/todo/partials/schedule_create_form.html #}

<div class="modal-header">
  <h5 class="modal-title">新しいスケジュールの作成</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<form id="create-task-form" method="post" action="{% url 'todo:create' %}">
  {% csrf_token %}
  <div class="modal-body">
    
    <div class="mb-3">
        <label for="{{ form.action_category.id_for_label }}" class="form-label">アクション区分</label>
        {{ form.action_category }}
        {% if form.action_category.errors %}
            <div class="text-danger small">{{ form.action_category.errors }}</div>
        {% endif %}
    </div>

    <div class="mb-3">
        <label for="{{ form.action_item.id_for_label }}" class="form-label">内容（本など）</label>
        {{ form.action_item }}
        <div class="form-text small">カテゴリに対応するリストから選択できます</div>
    </div>

    <div class="mb-3" id="create-page-count-area" style="display: none;">
        <label class="form-label">読書ページ記録</label>
        
        <div class="input-group mb-2">
            <span class="input-group-text">P.</span>
            {{ form.start_page }}
            <span class="input-group-text">〜</span>
            {{ form.end_page }}
        </div>

        <div class="input-group">
            <span class="input-group-text">合計</span>
            {{ form.page_count }}
            <span class="input-group-text">ページ</span>
        </div>
        <div class="form-text small">終了ページを入力すると自動で差分が計算されます</div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.start_time.id_for_label }}" class="form-label">開始</label>
            {{ form.start_time }}
        </div>
        <div class="col-md-6 mb-3">
            <label for="{{ form.end_time.id_for_label }}" class="form-label">終了</label>
            {{ form.end_time }}
        </div>
    </div>

  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
    <button type="button" id="submit-create-form" class="btn btn-primary">保存</button>
  </div>
</form>

<script>
    (function() {
        // ビューから渡されたデータを受け取る
        const trackPagesMap = {{ track_pages_map|safe }};
        const itemsByCategory = {{ items_by_category|safe }};
        
        const categorySelect = document.getElementById('id_action_category');
        const itemSelect = document.getElementById('id_action_item');
        const pageCountArea = document.getElementById('create-page-count-area');
        
        // ★追加: 計算用の入力要素を取得
        // forms.pyでwidgetのattrsにidを設定している前提（例: id='id_start_page'）
        const startInput = document.getElementById('id_start_page');
        const endInput = document.getElementById('id_end_page');
        const countInput = document.getElementById('id_page_count');

        // ▼ 自動計算ロジック
        function calculatePages() {
            const start = parseInt(startInput.value) || 0;
            const end = parseInt(endInput.value) || 0;
            
            // 終了ページが入力されていて、かつ開始ページ以上の場合に計算
            if (endInput.value !== '' && end >= start) {
                countInput.value = end - start;
            }
        }

        // 入力イベントに計算ロジックを紐付け
        if (startInput && endInput) {
            startInput.addEventListener('input', calculatePages);
            endInput.addEventListener('input', calculatePages);
        }

        // ▼ 1. アイテムリストを更新する関数
        function updateItemOptions() {
            const selectedId = categorySelect.value;
            const currentItemId = itemSelect.value;

            itemSelect.innerHTML = '<option value="">（指定なし）</option>';

            if (selectedId && itemsByCategory[selectedId]) {
                const items = itemsByCategory[selectedId];
                items.forEach(function(item) {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.title;
                    itemSelect.appendChild(option);
                });
            }
            
            if (currentItemId) {
                itemSelect.value = currentItemId;
            }
        }

        // ▼ 2. ページ数入力欄の表示/非表示を切り替える関数
        function togglePageCount() {
            const selectedId = categorySelect.value;
            if (selectedId && trackPagesMap[selectedId]) {
                pageCountArea.style.display = 'block';
            } else {
                pageCountArea.style.display = 'none';
                if (countInput) countInput.value = ''; // 隠すときは値をクリア
                // 開始・終了もクリアする場合は以下を追加
                if (startInput) startInput.value = '';
                if (endInput) endInput.value = '';
            }
        }

        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                updateItemOptions();
                togglePageCount();
            });
            
            togglePageCount();
        }
    })();
</script>