{# templates/todo/partials/schedule_create_form.html #}

<div class="modal-header">
  <h5 class="modal-title">新しいスケジュールの作成</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<form id="create-task-form" method="post" action="{% url 'todo:create' %}">
  {% csrf_token %}
  <div class="modal-body">
    
    <div class="mb-3">
        <label for="{{ form.action_category.id_for_label }}" class="form-label">アクション区分</label>
        {{ form.action_category }}
        {% if form.action_category.errors %}
            <div class="text-danger small">{{ form.action_category.errors }}</div>
        {% endif %}
    </div>

    <div class="mb-3">
        <label for="{{ form.action_item.id_for_label }}" class="form-label">内容（本など）</label>
        {{ form.action_item }}
        <div class="form-text small">カテゴリに対応するリストから選択できます</div>
    </div>

    <div class="mb-3" id="create-page-count-area" style="display: none;">
        <label for="{{ form.page_count.id_for_label }}" class="form-label">読んだページ数</label>
        <div class="input-group">
            {{ form.page_count }}
            <span class="input-group-text">ページ</span>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.start_time.id_for_label }}" class="form-label">開始</label>
            {{ form.start_time }}
        </div>
        <div class="col-md-6 mb-3">
            <label for="{{ form.end_time.id_for_label }}" class="form-label">終了</label>
            {{ form.end_time }}
        </div>
    </div>

  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
    <button type="button" id="submit-create-form" class="btn btn-primary">保存</button>
  </div>
</form>

<script>
    (function() {
        // ビューから渡されたデータを受け取る
        const trackPagesMap = {{ track_pages_map|safe }};
        const itemsByCategory = {{ items_by_category|safe }};
        
        const categorySelect = document.getElementById('id_action_category');
        const itemSelect = document.getElementById('id_action_item');
        const pageCountArea = document.getElementById('create-page-count-area');
        const pageCountInput = document.getElementById('id_page_count');

        // ▼ 1. アイテムリストを更新する関数
        function updateItemOptions() {
            const selectedId = categorySelect.value;
            const currentItemId = itemSelect.value; // 今選ばれている値を保存

            // 選択肢をクリア（"指定なし" だけ残す）
            itemSelect.innerHTML = '<option value="">（指定なし）</option>';

            if (selectedId && itemsByCategory[selectedId]) {
                const items = itemsByCategory[selectedId];
                items.forEach(function(item) {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.title;
                    itemSelect.appendChild(option);
                });
            }
            
            // カテゴリ変更後も、もし同じIDのアイテムがあれば選択状態を維持（編集時などに有効）
            if (currentItemId) {
                // optionが存在するか確認してからセットするのが丁寧だが、
                // 存在しない値をセットしても無視されるだけなので簡易的にセット
                itemSelect.value = currentItemId;
            }
        }

        // ▼ 2. ページ数入力欄の表示/非表示を切り替える関数（ここが消えていました！）
        function togglePageCount() {
            const selectedId = categorySelect.value;
            // マップを参照して、記録対象なら表示
            if (selectedId && trackPagesMap[selectedId]) {
                pageCountArea.style.display = 'block';
            } else {
                pageCountArea.style.display = 'none';
                if (pageCountInput) pageCountInput.value = ''; // 隠すときは値をクリア
            }
        }

        if (categorySelect) {
            // カテゴリ変更時に両方の処理を実行
            categorySelect.addEventListener('change', function() {
                updateItemOptions();
                togglePageCount();
            });
            
            // 初期表示時の実行（ページ数表示のみ）
            // アイテムリストはサーバー側で初期構築されているはずなので、JSでの更新は必須ではない
            togglePageCount();
        }
    })();
</script>