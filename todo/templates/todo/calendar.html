{% extends 'todo/base.html' %}

{% block header %}
  {% if user.is_authenticated %}
  <div class="d-flex flex-wrap gap-2 mb-3">
    <button class="btn btn-primary"
            hx-get="{% url 'todo:create_form' %}"
            hx-target="#modal-content"
            data-bs-toggle="modal"
            data-bs-target="#modal">
      &#12473;&#12465;&#12472;&#12517;&#12540;&#12523;&#20316;&#25104;
    </button>
    <a class="btn btn-secondary" href="{% url 'todo:action_item_list' %}">Todoリスト</a>
    <a class="btn btn-secondary" href="{% url 'todo:category_list' %}">&#12459;&#12486;&#12468;&#12522;&#31649;&#29702;</a>
    <a class="btn btn-info" href="{% url 'todo:weekly_summary' %}">&#36913;&#38291;&#12469;&#12510;&#12522;&#12540;</a>
    <a class="btn btn-success" href="{% url 'todo:monthly_summary' %}">&#26376;&#38291;&#12469;&#12510;&#12522;&#12540;</a>
    <a class="btn btn-outline-primary" href="{% url 'todo:today_tasks_setup' %}" data-popup="true">&#20170;&#26085;&#12398;&#35373;&#23450;</a>
    <a class="btn btn-outline-primary" href="{% url 'todo:today_dashboard' %}" data-popup="true">&#20170;&#26085;&#12398;Todo</a>
  </div>
  {% endif %}
{% endblock header %}


{% block content %}
<div id='calendar'></div>
{% endblock content %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      locale: 'ja',
      nowIndicator: true,
      events: '{% url "todo:calendar_events" %}',
      selectable: true,
      // 日付や時間がクリックされた時に実行される関数
  dateClick: function(info) {
    // 1. URLを生成
    const url = `{% url 'todo:create_form' %}?start_time=${info.dateStr}`;
    
    // 2. モーダルを先に表示（空の状態で）
    const modal = new bootstrap.Modal(document.getElementById('modal'));
    modal.show();

    // 3. HTMXを使って中身をロード（これならスクリプトが動く！）
    htmx.ajax('GET', url, {
        target: '#modal-content',
        swap: 'innerHTML'
    });
},
      editable: true,
      eventDrop: function(info) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const data = {
          id: info.event.id, // 'task_id' から 'id' に変更
            start: info.event.startStr,
            end: info.event.endStr,
        };
        fetch('{% url "todo:update_schedule_time" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
          if (data.status !== 'success') {
            alert('エラーが発生しました。');
            info.revert();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('通信エラーが発生しました。');
          info.revert();
        });
      },
      eventResize: function(info) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const data = {
          id: info.event.id, // 'task_id' から 'id' に変更
          start: info.event.startStr,
          end: info.event.endStr,
        };
        fetch('{% url "todo:update_schedule_time" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
          if (data.status !== 'success') {
            alert('エラーが発生しました。');
            info.revert();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('通信エラーが発生しました。');
          info.revert();
        });
      }
    });
    calendar.render();

    const modalEl = document.getElementById('modal');
    modalEl.addEventListener('click', function(event) {
      let form = null;
      let submitUrl = null;
      if (event.target.id === 'submit-create-form') {
        form = document.getElementById('create-task-form');
        submitUrl = form.action;
      }
      else if (event.target.id === 'submit-edit-form') {
        form = document.getElementById('edit-task-form');
        submitUrl = form.action;
      }
      if (form && submitUrl) {
        htmx.ajax('POST', submitUrl, {
          target: '#modal-content',
          swap: 'innerHTML',
          source: form
        });
      }
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('a[data-popup="true"]').forEach(function(link) {
      link.addEventListener('click', function(event) {
        event.preventDefault();
        const url = link.getAttribute('href');
        window.open(
          url,
          '_blank',
          'width=1100,height=800,menubar=0,toolbar=0,location=0,status=0,scrollbars=1,resizable=1'
        );
      });
    });
  });
</script>
{% endblock %}
