{% extends 'todo/base.html' %}

{% block header %}
  <h2>{{ schedule.title }}</h2>
  <p><small class="text-muted">{{ schedule.start_time }} - {{ schedule.end_time }}</small></p>
  <div class="mt-3 p-3 bg-light rounded">
    <p class="mb-1"><strong>目標:</strong><br> {{ schedule.action_item.text1|default:"(未設定)" }}</p>
  </div>
  <div>
      <button class="btn btn-secondary"
              hx-get="{% url 'todo:edit_form' pk=schedule.pk %}"
              hx-target="#modal-content"
              data-bs-toggle="modal"
              data-bs-target="#modal">
        編集
      </button>
      <button class="btn btn-danger"
              hx-post="{% url 'todo:delete' pk=schedule.pk %}"
              hx-confirm="このスケジュールを本当に削除しますか？"
              hx-target="body"
              hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
        削除
      </button>
    </div>
{% endblock header %}

{% block content %}
<h2 id="countdown-timer" class="text-center text-primary mb-4">計算中...</h2>

  <div id="task-section">
    {% include 'todo/partials/task_list_and_progress.html' %}
  </div>
  <hr>
  <a href="{% url 'todo:calendar' %}">カレンダーに戻る</a>
{% endblock content %}

{% block extra_js %}
<script>
  // Djangoテンプレートから終了時刻の文字列を取得
  const endTimeString = "{{ schedule.end_time.isoformat }}";
  
  // 終了時刻をJavaScriptのDateオブジェクトに変換
  const endTime = new Date(endTimeString);

  // タイマーを表示するHTML要素を取得
  const timerElement = document.getElementById('countdown-timer');

  // 1秒ごとに関数を実行する
  const countdownInterval = setInterval(() => {
    // 現在時刻を取得
    const now = new Date();

    // 終了時刻までの残り時間をミリ秒で計算
    const remainingTime = endTime - now;

    // もし残り時間があれば
    if (remainingTime > 0) {
      // ミリ秒を時、分、秒に変換
      const hours = Math.floor((remainingTime / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((remainingTime / 1000 / 60) % 60);
      const seconds = Math.floor((remainingTime / 1000) % 60);

      // 2桁になるように0で埋める
      const paddedHours = String(hours).padStart(2, '0');
      const paddedMinutes = String(minutes).padStart(2, '0');
      const paddedSeconds = String(seconds).padStart(2, '0');

      // HTML要素のテキストを更新
      timerElement.textContent = `終了まであと ${paddedHours} 時間 ${paddedMinutes} 分 ${paddedSeconds} 秒`;
    } else {
      // 残り時間がなければ「終了しました」と表示
      timerElement.textContent = "このスケジュールは終了しました";
      timerElement.classList.remove('text-primary');
      timerElement.classList.add('text-success');
      // インターバルを停止
      clearInterval(countdownInterval);
    }
  }, 1000); // 1000ミリ秒 = 1秒ごと
</script>

<script>
document.addEventListener('DOMContentLoaded', (event) => {
    const taskList = document.getElementById('task-list');
    if (taskList) {
        new Sortable(taskList, {
            handle: '.drag-handle',
            animation: 150,
            // ドラッグ＆ドロップ操作が完了したときにこの関数が呼ばれる
            onEnd: function (evt) {
                // 並び替えられた後のすべてのinput要素を取得
                const inputs = taskList.querySelectorAll('input[name="task_pks"]');
                
                // input要素からvalue（タスクのID）を取り出して配列にする
                const taskIds = Array.from(inputs).map(input => input.value);

                // HTMXを使ってサーバーに新しい順序を送信
                htmx.ajax('POST', '{% url "todo:reorder_tasks" %}', {
                    // 送信するデータ
                    values: {
                        // 'task_pks'というキーで、IDの配列を渡す
                        // Django側は request.POST.getlist('task_pks') で受け取る
                        'task_pks': taskIds
                    },
                    // DjangoのCSRFトークンをヘッダーに含める
                    headers: {'X-CSRFToken': '{{ csrf_token }}'}
                });
            }
        });
    }
});
</script>
{% endblock extra_js %}